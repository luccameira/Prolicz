<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Novo Cliente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="layout.css">
  <link rel="stylesheet" href="formulario.css">
  <script src="incluir-layout.js" defer></script>
  <script src="novo-cliente.js" defer></script>
</head>
<body>
  <div class="topbar"></div>
  <div class="sidebar"></div>

  <div class="content">
    <h1 class="titulo-pagina">Novo Cliente</h1>
    <form id="form-cliente">
      <div class="form-section">
        <h2>Dados Básicos</h2>
        <div class="linha">
          <div class="campo">
            <label for="tipo_pessoa">Tipo de Pessoa</label>
            <select id="tipo_pessoa" name="tipo_pessoa" required>
              <option value="">Selecione</option>
              <option value="Física">Física</option>
              <option value="Jurídica">Jurídica</option>
            </select>
          </div>
          <div class="campo">
            <label for="documento">CPF/CNPJ</label>
            <input type="text" id="documento" name="documento" required>
          </div>
        </div>

        <div class="linha">
          <div class="campo">
            <label for="nome_fantasia">Nome Fantasia</label>
            <input type="text" id="nome_fantasia" name="nome_fantasia" required>
          </div>
          <div class="campo">
            <label for="codigo_fiscal">Código Fiscal</label>
            <select id="codigo_fiscal" name="codigo_fiscal" required>
              <option value="">Selecione</option>
              <option value="GA1">GA1</option>
              <option value="GA2">GA2</option>
              <option value="GX">GX</option>
              <option value="Outros">Outros</option>
            </select>
          </div>
        </div>

        <div class="linha">
          <div class="campo">
            <label for="situacao_tributaria">Situação Tributária</label>
            <input type="text" id="situacao_tributaria" name="situacao_tributaria" required>
          </div>
          <div class="campo">
            <label for="meio_pagamento">Meio de Pagamento</label>
            <select id="meio_pagamento" name="meio_pagamento" required>
              <option value="">Selecione</option>
              <option value="Transferência">Transferência</option>
              <option value="Boleto">Boleto</option>
              <option value="Dinheiro">Dinheiro</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h2>Endereço</h2>
        <div class="linha">
          <div class="campo">
            <label for="cep">CEP</label>
            <input type="text" id="cep" name="cep">
          </div>
          <div class="campo">
            <label for="logradouro">Logradouro</label>
            <input type="text" id="logradouro" name="logradouro">
          </div>
          <div class="campo">
            <label for="numero">Número</label>
            <input type="text" id="numero" name="numero">
          </div>
        </div>

        <div class="linha">
          <div class="campo">
            <label for="bairro">Bairro</label>
            <input type="text" id="bairro" name="bairro">
          </div>
          <div class="campo">
            <label for="cidade">Cidade</label>
            <input type="text" id="cidade" name="cidade">
          </div>
          <div class="campo">
            <label for="estado">Estado</label>
            <input type="text" id="estado" name="estado">
          </div>
        </div>
      </div>

            <div class="form-section">
        <h2>Contatos</h2>
        <div id="lista-contatos"></div>
        <button type="button" class="btn-secundario" onclick="adicionarContato()">Adicionar Contato</button>
      </div>

      <div class="form-section">
        <h2>Produtos Autorizados</h2>
        <div class="linha">
          <div class="campo" style="flex: 2;">
            <label for="produto">Produto</label>
            <select id="produto"></select>
          </div>
          <div class="campo">
            <label for="valor_unitario">Valor Unitário</label>
            <input type="text" id="valor_unitario">
          </div>
          <div class="campo">
            <label>&nbsp;</label>
            <button type="button" class="btn-secundario" onclick="adicionarProduto()">Adicionar</button>
          </div>
        </div>
        <div id="lista-produtos"></div>
      </div>

      <div class="form-section">
        <h2>Prazos de Pagamento</h2>
        <div class="linha">
          <div class="campo">
            <label for="descricao_prazo">Descrição</label>
            <input type="text" id="descricao_prazo" placeholder="Ex: À vista, 7 dias">
          </div>
          <div class="campo">
            <label for="dias_prazo">Dias após coleta</label>
            <input type="number" id="dias_prazo" placeholder="Ex: 0, 7, 30">
          </div>
          <div class="campo">
            <label>&nbsp;</label>
            <button type="button" class="btn-secundario" onclick="adicionarPrazo()">Adicionar</button>
          </div>
        </div>
        <div id="lista-prazos"></div>
      </div>

      <div class="form-section">
        <button type="submit" class="btn-principal">Salvar Cliente</button>
      </div>
    </form>
  </div>

    <template id="template-contato">
    <div class="linha grupo-contato">
      <div class="campo">
        <label>Nome</label>
        <input type="text" name="contato_nome[]" required>
      </div>
      <div class="campo">
        <label>Telefone</label>
        <input type="text" name="contato_telefone[]" required>
      </div>
      <div class="campo">
        <label>Email</label>
        <input type="email" name="contato_email[]" required>
      </div>
      <div class="campo">
        <label>&nbsp;</label>
        <button type="button" onclick="this.parentElement.parentElement.remove()">Remover</button>
      </div>
    </div>
  </template>

  <template id="template-produto">
    <div class="linha grupo-produto">
      <div class="campo" style="flex: 2;">
        <input type="text" class="produto-nome" readonly>
        <input type="hidden" name="produto_id[]">
      </div>
      <div class="campo">
        <input type="text" name="valor_unitario[]" required>
      </div>
      <div class="campo">
        <button type="button" onclick="this.parentElement.parentElement.remove()">Remover</button>
      </div>
    </div>
  </template>

  <template id="template-prazo">
    <div class="linha grupo-prazo">
      <div class="campo">
        <input type="text" name="prazo_descricao[]" class="descricao-prazo" required readonly>
      </div>
      <div class="campo">
        <input type="number" name="prazo_dias[]" class="dias-prazo" required readonly>
      </div>
      <div class="campo">
        <button type="button" onclick="this.parentElement.parentElement.remove()">Remover</button>
      </div>
    </div>
  </template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
      carregarProdutos();
      document.getElementById('form-cliente').addEventListener('submit', salvarCliente);
    });

    function adicionarContato() {
      const template = document.getElementById('template-contato').content.cloneNode(true);
      document.getElementById('lista-contatos').appendChild(template);
    }

    function adicionarProduto() {
      const select = document.getElementById('produto');
      const produtoId = select.value;
      const nomeProduto = select.options[select.selectedIndex].text;
      const valor = document.getElementById('valor_unitario').value;

      if (!produtoId || !valor) return;

      const template = document.getElementById('template-produto').content.cloneNode(true);
      template.querySelector('.produto-nome').value = nomeProduto;
      template.querySelector('input[name="produto_id[]"]').value = produtoId;
      template.querySelector('input[name="valor_unitario[]"]').value = valor;
      document.getElementById('lista-produtos').appendChild(template);

      document.getElementById('produto').value = '';
      document.getElementById('valor_unitario').value = '';
    }

    function adicionarPrazo() {
      const descricao = document.getElementById('descricao_prazo').value;
      const dias = document.getElementById('dias_prazo').value;

      if (!descricao || dias === '') return;

      const template = document.getElementById('template-prazo').content.cloneNode(true);
      template.querySelector('.descricao-prazo').value = descricao;
      template.querySelector('.dias-prazo').value = dias;
      document.getElementById('lista-prazos').appendChild(template);

      document.getElementById('descricao_prazo').value = '';
      document.getElementById('dias_prazo').value = '';
    }

    async function carregarProdutos() {
      const res = await fetch('/api/clientes/produtos');
      const produtos = await res.json();
      const select = document.getElementById('produto');
      produtos.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.nome} (${p.unidade})`;
        select.appendChild(opt);
      });
    }

    async function salvarCliente(e) {
      e.preventDefault();

      const contatos = [...document.querySelectorAll('.grupo-contato')].map(grupo => ({
        nome: grupo.querySelector('[name="contato_nome[]"]').value,
        telefone: grupo.querySelector('[name="contato_telefone[]"]').value,
        email: grupo.querySelector('[name="contato_email[]"]').value
      }));

      const produtos = [...document.querySelectorAll('.grupo-produto')].map(grupo => ({
        id: grupo.querySelector('[name="produto_id[]"]').value,
        valor: grupo.querySelector('[name="valor_unitario[]"]').value
      }));

      const prazos = [...document.querySelectorAll('.grupo-prazo')].map(grupo => ({
        descricao: grupo.querySelector('[name="prazo_descricao[]"]').value,
        dias: grupo.querySelector('[name="prazo_dias[]"]').value
      }));

      const dados = {
        tipo_pessoa: document.getElementById('tipo_pessoa').value,
        documento: document.getElementById('documento').value,
        nome_fantasia: document.getElementById('nome_fantasia').value,
        situacao_tributaria: document.getElementById('situacao_tributaria').value,
        codigo_fiscal: document.getElementById('codigo_fiscal').value,
        cep: document.getElementById('cep').value,
        logradouro: document.getElementById('logradouro').value,
        numero: document.getElementById('numero').value,
        bairro: document.getElementById('bairro').value,
        cidade: document.getElementById('cidade').value,
        estado: document.getElementById('estado').value,
        meio_pagamento: document.getElementById('meio_pagamento').value,
        contatos,
        produtos,
        prazos
      };

      const res = await fetch('/api/clientes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });

      const resposta = await res.json();
      if (res.ok) {
        alert('Cliente cadastrado com sucesso!');
        location.reload();
      } else {
        alert(resposta.erro || 'Erro ao salvar cliente.');
      }
    }
  </script>
</body>
</html>



