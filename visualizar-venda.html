<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Visualizar Venda</title>
  <link rel="stylesheet" href="layout.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script defer src="incluir-layout.js"></script>
  <style>
    /* Conteúdo principal já com margem para sidebar */
    .main-content {
      position: relative;
      max-width: 960px;
      margin-left: 280px;
      padding: 100px 40px 40px;
      background-color: #f4f6f8;
      min-height: 100vh;
      box-sizing: border-box;
    }

    /* Título da página */
    h1 {
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 28px;
    }

    /* Botão voltar */
    .btn-voltar {
      margin-bottom: 30px;
      padding: 8px 18px;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
    }

    .btn-voltar:hover {
      background-color: #5a6268;
    }

    /* Cabeçalho do cliente */
    .cliente-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    /* Círculo com iniciais */
    .cliente-inicial {
      width: 80px;
      height: 80px;
      background-color: #FFC107; /* amarelo */
      color: black;
      font-weight: 700;
      font-size: 36px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      user-select: none;
    }

    .tabs-menu a.active {
      background-color: #fff3cd;
      color: #000 !important;
      border-radius: 8px;
      padding: 6px 12px;
      border: 1px solid #ffc107;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-bottom-color: transparent;
      text-shadow: none;
    }

    .cliente-info .nome-cliente {
      font-weight: 900;
      font-size: 28px;
      color: #222;
    }

    /* Menu abas */
    .tabs-menu {
      border-bottom: 1px solid #ccc;
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .tabs-menu a {
      padding-bottom: 6px;
      text-decoration: none;
      color: #000;
      font-weight: 700;
      font-size: 16px;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      user-select: none;
    }

    .tabs-menu a.active {
      border-bottom-color: #000000;
      color: #000000;
      background-color: #FFC107;
      border-radius: 6px;
      padding: 4px 12px;
      box-shadow: 0 0 6px rgba(0,0,0,0.15);
    }

    /* Conteúdo das abas */
    .tab-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgb(0 0 0 / 0.1);
      min-height: 180px;
    }

    /* Títulos dentro do conteúdo */
    .tab-section {
      margin-bottom: 20px;
    }
    .tab-section h3 {
      font-weight: 700;
      margin-bottom: 12px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
      font-size: 18px;
    }

    /* Listas de dados em colunas */
    .tab-section dl {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px 40px;
    }

    .tab-section dt {
      font-weight: 700;
      color: #333;
    }

    .tab-section dd {
      margin: 0;
      color: #555;
      font-weight: 400;
      font-size: 14px;
    }

    /* Lista simples para contatos e prazos */
    .lista-simples {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .lista-simples li {
      margin-bottom: 8px;
      font-size: 14px;
      color: #555;
    }

    /* Produto bloco */
    .produto-bloco {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      background: #f9f9f9;
    }

    .produto-bloco .form-group {
      margin-bottom: 12px;
    }

    .produto-bloco label {
      font-weight: 700;
      display: block;
      margin-bottom: 6px;
    }

    .produto-bloco input {
      width: 100%;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #bbb;
      background: #e9ecef;
      font-size: 14px;
      color: #333;
    }

    .info-bloco {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px 25px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    }

    .info-bloco h3 {
      margin-bottom: 15px;
      font-weight: 700;
      font-size: 20px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 8px;
    }

    .info-bloco dl {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 10px 20px;
    }

    .info-bloco dt {
      font-weight: 700;
      color: #444;
      align-self: center;
    }

    .info-bloco dd {
      margin: 0;
      color: #666;
      font-size: 15px;
      align-self: center;
      text-align: right;
    }

    #info-pedido.tab-content {
      background: transparent;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
      min-height: auto;
    }

    .timeline-container {
      position: relative;
      margin-left: 0;
      padding-left: 40px;
      border-left: 2px solid #ccc;
      max-width: 600px;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 30px;
      padding-left: 30px;
    }

    .timeline-item:last-child {
      margin-bottom: 0;
    }

    .timeline-dot {
      width: 16px;
      height: 16px;
      background-color: #FFC107;
      border: 2px solid #b38f00;
      border-radius: 50%;
      position: absolute;
      left: 0;
      top: 4px;
      box-shadow: 0 0 4px rgba(0,0,0,0.2);
    }

    .timeline-toggle {
      cursor: pointer;
      display: inline-block;
      padding: 10px 12px;
      border-radius: 6px;
      user-select: none;
      transition: background-color 0.2s ease;
      font-weight: 700;
      font-size: 16px;
      background: #fff;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.12);
      margin-bottom: 6px;
    }
    .timeline-toggle:hover {
      background-color: #fff3cd;
    }

    .timeline-content {
      background: #fff;
      padding: 12px 16px;
      border-radius: 6px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.12);
      max-width: 520px;
      font-size: 15px;
      color: #222;
      line-height: 1.4;
      margin-bottom: 30px;
    }

    .timeline-content strong {
      font-weight: 700;
      font-size: 16px;
      display: block;
      margin-bottom: 6px;
    }

    .timeline-date {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="topbar"></div>
  <div class="sidebar"></div>

  <div class="main-content">
    <a href="vendas.html" class="btn-voltar">&larr; Voltar</a>

    <div class="cliente-header">
      <div class="cliente-inicial" id="cliente-inicial">--</div>
      <div class="cliente-info">
        <div class="nome-cliente" id="nome-cliente">—</div>
        <div class="info-adicional" id="info-adicional">—</div>
      </div>
    </div>

    <nav class="tabs-menu">
      <a href="#" class="active" data-tab="info-pedido">Informações Principais</a>
      <a href="#" data-tab="observacoes">Observações</a>
      <a href="#" data-tab="historico-pedido">Histórico do Pedido</a>
    </nav>

    <section id="info-pedido" class="tab-content">
      <div class="info-bloco tab-section">
        <h3>Informações do Pedido</h3>
        <dl>
          <dt>Data Prevista da Coleta</dt><dd id="data-coleta">—</dd>
          <dt>Pedido Para</dt><dd id="pedido-para">—</dd>
          <dt>Prazo de Pagamento</dt><dd id="prazo-pagamento">—</dd>
          <dt>Condição para Pagamento à Vista</dt><dd id="condicao-pagamento">—</dd>
          <dt>Código</dt><dd id="codigo-fiscal">—</dd>
          <dt>Desconto</dt><dd id="informações do desconto">—</dd>
        </dl>
      </div>
      <div class="info-bloco tab-section" style="margin-top: 30px;">
        <h3>Informações do Produto</h3>
        <dl>
          <dt>Nome do Produto</dt><dd id="nome-produto">—</dd>
          <dt>Valor por Quilo</dt><dd id="valor-quilo">—</dd>
          <dt>Peso (Kg)</dt><dd id="peso">—</dd>
          <dt>Tipo de Peso</dt><dd id="tipo-peso">—</dd>
          <dt>Subtotal</dt><dd id="subtotal">—</dd>
        </dl>
      </div>
    </section>

    <section id="produtos-autorizados" class="tab-content" style="display:none;">
      <div id="produtos-container"></div>
    </section>

    <section id="contatos" class="tab-content" style="display:none;">
      <ul class="lista-simples" id="lista-contatos"></ul>
    </section>

    <section id="prazos-pagamento" class="tab-content" style="display:none;">
      <ul class="lista-simples" id="lista-prazos"></ul>
    </section>

    <section id="historico-pedido" class="tab-content">
      <div class="timeline-container">

        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div
            class="timeline-toggle"
            role="button"
            tabindex="0"
            aria-expanded="false"
            aria-controls="info1"
            id="toggle1"
          >
            Pedido Criado
            <div class="timeline-date">26/06/2023 14:03</div>
          </div>
          <div
            class="timeline-content"
            id="info1"
            role="region"
            aria-labelledby="toggle1"
            hidden
          >
            <p><strong>Usuário:</strong> Fulano</p>
            <p><strong>Empresa Fornecedora:</strong> PRONASA</p>
            <p><strong>Produto:</strong> Produto Teste</p>
            <p><strong>Data Prevista da Coleta:</strong> 28/06/2025</p>
            <p><strong>Pedido Para:</strong> Retirar</p>
            <p><strong>O Peso é:</strong> Aproximado</p>
            <p><strong>Peso Previsto:</strong> 1100 Kg</p>
            <p><strong>Prazo de Pagamento:</strong> A Vista</p>
            <p><strong>Código:</strong> Personalizado</p>
            <p><strong>Observação:</strong> Obs teste</p>
          </div>
        </div>

        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div
            class="timeline-toggle"
            role="button"
            tabindex="0"
            aria-expanded="false"
            aria-controls="info2"
            id="toggle2"
          >
            Entrada na Portaria
            <div class="timeline-date">26/06/2023 15:45</div>
          </div>
          <div
            class="timeline-content"
            id="info2"
            role="region"
            aria-labelledby="toggle2"
            hidden
          >
            <p><strong>Usuário:</strong> Nome do usuário aqui</p>
            <p><strong>CPF Motorista:</strong> CPF do motorista aqui</p>
            <p><strong>Placa do Veículo:</strong> Placa do veículo aqui</p>
            <p><strong>Nome do Ajudante (caso tenha):</strong> Nome do ajudante aqui</p>
            <p><strong>CPF do Ajudante (caso tenha):</strong> CPF do ajudante aqui</p>
          </div>
        </div>

        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div
            class="timeline-toggle"
            role="button"
            tabindex="0"
            aria-expanded="false"
            aria-controls="info3"
            id="toggle3"
          >
            Coleta Iniciada
            <div class="timeline-date">26/06/2023 15:20</div>
          </div>
          <div
            class="timeline-content"
            id="info3"
            role="region"
            aria-labelledby="toggle3"
            hidden
          >
            <p><strong>Usuário:</strong> Nome do usuário aqui</p>
<p><strong>Coleta Finalizada:</strong> Data e hora da coleta finalizada aqui</p>
<p><strong>Ticket da Balança (Pedido):</strong> Link ou nome do ticket aqui</p>
<p><strong>Desconto (caso tenha):</strong> Valor do desconto aqui</p>
<p><strong>Ticket da Balança (Desconto - caso tenha):</strong> Link ou nome do ticket de desconto aqui</p>
          </div>
        </div>

        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div
            class="timeline-toggle"
            role="button"
            tabindex="0"
            aria-expanded="false"
            aria-controls="info4"
            id="toggle4"
          >
            Peso Conferido
            <div class="timeline-date">26/06/2023 17:10</div>
          </div>
          <div
            class="timeline-content"
            id="info4"
            role="region"
            aria-labelledby="toggle4"
            hidden
          >
            <p><strong>Usuário:</strong> Nome do usuário aqui</p>
          </div>
        </div>

        <!-- Financeiro -->
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div
            class="timeline-toggle"
            role="button"
            tabindex="0"
            aria-expanded="false"
            aria-controls="info5"
            id="toggle5"
          >
            Cliente Liberado
            <div class="timeline-date">27/06/2023 09:30</div>
          </div>
          <div
            class="timeline-content"
            id="info5"
            role="region"
            aria-labelledby="toggle5"
            hidden
          >
            <p><strong>Usuário:</strong> Nome do usuário aqui</p>
<p><strong>Vencimentos:</strong> Informações dos vencimentos aqui</p>
<p><strong>Peso (Desconto - caso tenha):</strong> Valor do peso com desconto aqui</p>
          </div>
        </div>

        <!-- Emissão de NF -->
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div
            class="timeline-toggle"
            role="button"
            tabindex="0"
            aria-expanded="false"
            aria-controls="info6"
            id="toggle6"
          >
           NF Emitida
            <div class="timeline-date">27/06/2023 10:15</div>
          </div>
          <div
            class="timeline-content"
            id="info6"
            role="region"
            aria-labelledby="toggle6"
            hidden
          >
            <p><strong>Usuário:</strong> Nome do usuário aqui</p>
<p><strong>Número da Nota Fiscal:</strong> 123456</p>
<p><strong>Arquivo ou Link da NF:</strong> <a href="link_ou_arquivo_aqui" target="_blank">Visualizar NF</a></p>
          </div>
        </div>

        <!-- Liberação Final -->
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div
            class="timeline-toggle"
            role="button"
            tabindex="0"
            aria-expanded="false"
            aria-controls="info7"
            id="toggle7"
          >
            Saída na Portaria
            <div class="timeline-date">27/06/2023 11:00</div>
          </div>
          <div
            class="timeline-content"
            id="info7"
            role="region"
            aria-labelledby="toggle7"
            hidden
          >
           <p><strong>Usuário:</strong> Nome do usuário aqui</p>
            <p><strong>Status:</strong> Pedido Liberado</p>
            <p><strong>Responsável:</strong> Supervisor</p>
            <p><strong>Data da Liberação:</strong> 27/06/2023</p>
          </div>
        </div>

      </div>
    </section>

    <script>
      // Função para exibir a aba selecionada
      function mostrarAba(abaId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.style.display = (tab.id === abaId) ? 'block' : 'none';
        });
        document.querySelectorAll('.tabs-menu a').forEach(link => {
          link.classList.toggle('active', link.dataset.tab === abaId);
        });
      }

      // Controla o clique nas abas
      document.querySelectorAll('.tabs-menu a').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          mostrarAba(link.dataset.tab);
        });
      });

      // Inicia exibindo a primeira aba ao carregar a página
      mostrarAba('info-pedido');

      // Extrair iniciais do nome do cliente
      function extrairIniciais(nome) {
        if (!nome) return '--';
        const nomes = nome.trim().split(' ');
        let iniciais = nomes.length >= 2
          ? nomes[0][0] + nomes[1][0]
          : nomes[0][0];
        return iniciais.toUpperCase();
      }

      // Carregar dados do pedido via API
      const urlParams = new URLSearchParams(window.location.search);
      const pedidoId = urlParams.get('id');

      function formatarData(dataStr) {
        if (!dataStr) return '—';
        const data = new Date(dataStr);
        if (isNaN(data)) return '—';
        return data.toLocaleDateString('pt-BR');
      }

      async function carregarPedido() {
        try {
          const res = await fetch(`/api/pedidos/${pedidoId}`);
          if (!res.ok) throw new Error('Pedido não encontrado');
          const pedido = await res.json();

          // Cabeçalho (iniciais e nome do cliente)
          document.getElementById('cliente-inicial').textContent = extrairIniciais(pedido.cliente_nome);
          document.getElementById('nome-cliente').textContent = pedido.cliente_nome || '—';
          document.getElementById('info-adicional').textContent = pedido.documento || '—';

          // Aba informações Principais
          document.getElementById('empresa').textContent = pedido.empresa || '—';
          document.getElementById('data-coleta').textContent = formatarData(pedido.data_coleta) || '—';
          document.getElementById('pedido-para').textContent = pedido.tipo || '—';
          document.getElementById('prazo-pagamento').textContent = pedido.prazo_pagamento || '—';
          document.getElementById('condicao-pagamento').textContent = pedido.condicao_pagamento_avista || '—';

          // Aba informações do produto
          if (pedido.materiais && pedido.materiais.length > 0) {
            const primeiroProduto = pedido.materiais[0];
            document.getElementById('nome-produto').textContent = primeiroProduto.nome_produto || '—';
            document.getElementById('valor-quilo').textContent = primeiroProduto.valor_unitario ? `R$ ${primeiroProduto.valor_unitario.toFixed(2).replace('.', ',')}` : '—';
            document.getElementById('peso').textContent = primeiroProduto.peso ? primeiroProduto.peso.toLocaleString('pt-BR') : '—';
            document.getElementById('tipo-peso').textContent = primeiroProduto.tipo_peso || '—';
            document.getElementById('subtotal').textContent = primeiroProduto.valor_total ? `R$ ${primeiroProduto.valor_total.toFixed(2).replace('.', ',')}` : '—';
            document.getElementById('codigo-fiscal').textContent = primeiroProduto.codigo_fiscal || '—';
          } else {
            document.getElementById('nome-produto').textContent = '—';
            document.getElementById('valor-quilo').textContent = '—';
            document.getElementById('peso').textContent = '—';
            document.getElementById('tipo-peso').textContent = '—';
            document.getElementById('subtotal').textContent = '—';
            document.getElementById('codigo-fiscal').textContent = '—';
          }

          // Abas Produtos Autorizados, Contatos e Prazos permanecem iguais

          // Produtos autorizados
          const produtosContainer = document.getElementById('produtos-container');
          produtosContainer.innerHTML = '';
          if (pedido.produtos_autorizados && pedido.produtos_autorizados.length > 0) {
            pedido.produtos_autorizados.forEach(prod => {
              const div = document.createElement('div');
              div.className = 'produto-bloco';
              div.innerHTML = `
                <div><strong>Produto:</strong> ${prod.nome_produto || '—'}</div>
                <div><strong>Valor:</strong> R$ ${prod.valor_unitario?.toFixed(2).replace('.', ',') || '—'}</div>
              `;
              produtosContainer.appendChild(div);
            });
          } else {
            produtosContainer.innerHTML = '<p>Sem produtos autorizados.</p>';
          }

          // Contatos
          const listaContatos = document.getElementById('lista-contatos');
          listaContatos.innerHTML = '';
          if (pedido.contatos && pedido.contatos.length > 0) {
            pedido.contatos.forEach(contato => {
              const li = document.createElement('li');
              li.innerHTML = `<strong>${contato.nome}</strong><br>${contato.telefone || ''}<br>${contato.email || ''}`;
              listaContatos.appendChild(li);
            });
          } else {
            listaContatos.innerHTML = '<li>Sem contatos cadastrados.</li>';
          }

          // Prazos de pagamento
          const listaPrazos = document.getElementById('lista-prazos');
          listaPrazos.innerHTML = '';
          if (pedido.prazos_pagamento && pedido.prazos_pagamento.length > 0) {
            pedido.prazos_pagamento.forEach(prazo => {
              const li = document.createElement('li');
              li.textContent = prazo.descricao || '—';
              listaPrazos.appendChild(li);
            });
          } else {
            listaPrazos.innerHTML = '<li>Sem prazos de pagamento.</li>';
          }

        } catch (error) {
          alert('Erro ao carregar pedido: ' + error.message);
        }
      }

      // Função para ativar os toggles da timeline
      function ativarToggleTimeline() {
        const toggles = document.querySelectorAll('.timeline-toggle');
        toggles.forEach(toggle => {
          toggle.addEventListener('click', () => {
            const conteudoId = toggle.getAttribute('aria-controls');
            const conteudo = document.getElementById(conteudoId);

            if (!conteudo) return;

            const isHidden = conteudo.hasAttribute('hidden');

            if (isHidden) {
              conteudo.removeAttribute('hidden');
              toggle.setAttribute('aria-expanded', 'true');
            } else {
              conteudo.setAttribute('hidden', '');
              toggle.setAttribute('aria-expanded', 'false');
            }
          });

          // Também ativar toggle via teclado (Enter e Espaço)
          toggle.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              toggle.click();
            }
          });
        });
      }

      // Ativa os toggles após carregar a página
      document.addEventListener('DOMContentLoaded', () => {
        ativarToggleTimeline();
        carregarPedido();
      });
    </script>
  </div>
</body>
</html>
